# üìä –°–∏—Å—Ç–µ–º–∞ —Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ Timly

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ —Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

#### `SubscriptionPlan` - –¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–∏–º–∏—Ç—ã –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç–∞—Ä–∏—Ñ–∞.

**–ü–æ–ª—è:**
- `plan_type` - –¢–∏–ø –ø–ª–∞–Ω–∞ (free, starter, professional, enterprise)
- `name` - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
- `price_monthly` / `price_yearly` - –¶–µ–Ω—ã
- `max_active_vacancies` - –õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π
- `max_analyses_per_month` - –õ–∏–º–∏—Ç –∞–Ω–∞–ª–∏–∑–æ–≤ –≤ –º–µ—Å—è—Ü
- `max_export_per_month` - –õ–∏–º–∏—Ç —ç–∫—Å–ø–æ—Ä—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
- `features` - JSON —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏

**–ú–µ—Ç–æ–¥—ã:**
- `has_feature(feature_name)` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
- `to_dict()` - –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è API

#### `Subscription` - –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∞—Ä–∏—Ñ–Ω—ã–º –ø–ª–∞–Ω–æ–º + –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

**–ü–æ–ª—è:**
- `user_id` - –í–ª–∞–¥–µ–ª–µ—Ü –ø–æ–¥–ø–∏—Å–∫–∏
- `plan_id` - –°–≤—è–∑—å —Å —Ç–∞—Ä–∏—Ñ–Ω—ã–º –ø–ª–∞–Ω–æ–º
- `status` - active, trial, expired, cancelled
- `started_at` / `expires_at` - –ü–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è
- `analyses_used_this_month` - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∞–Ω–∞–ª–∏–∑–æ–≤
- `exports_used_this_month` - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–æ–≤
- `last_reset_at` - –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞ —Å—á—ë—Ç—á–∏–∫–æ–≤

**–°–≤–æ–π—Å—Ç–≤–∞:**
- `is_active` - –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
- `days_remaining` - –î–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
- `usage_percentage` - –ü—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤

**–ú–µ—Ç–æ–¥—ã:**
- `can_analyze()` - –ú–æ–∂–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑
- `can_export()` - –ú–æ–∂–Ω–æ –ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
- `reset_monthly_usage()` - –°–±—Ä–æ—Å –º–µ—Å—è—á–Ω—ã—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤

#### `UsageLog` - –õ–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
–ê—É–¥–∏—Ç –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

**–ü–æ–ª—è:**
- `user_id` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `action_type` - –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (analysis, export, sync)
- `vacancy_id` / `application_id` - –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
- `metadata` - JSON —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

---

## üìã –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

### Free (–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
- **–¶–µ–Ω–∞:** 0 ‚ÇΩ
- **–í–∞–∫–∞–Ω—Å–∏–∏:** 1 –∞–∫—Ç–∏–≤–Ω–∞—è
- **–ê–Ω–∞–ª–∏–∑—ã:** 20/–º–µ—Å—è—Ü
- **–≠–∫—Å–ø–æ—Ä—Ç—ã:** 5/–º–µ—Å—è—Ü
- **–§—É–Ω–∫—Ü–∏–∏:**
  - ‚úÖ –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
  - ‚úÖ Email –ø–æ–¥–¥–µ—Ä–∂–∫–∞
  - ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
  - ‚ùå API –¥–æ—Å—Ç—É–ø
  - ‚ùå –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

### Starter
- **–¶–µ–Ω–∞:** 2990 ‚ÇΩ/–º–µ—Å –∏–ª–∏ 29900 ‚ÇΩ/–≥–æ–¥ (~16% —Å–∫–∏–¥–∫–∞)
- **–í–∞–∫–∞–Ω—Å–∏–∏:** 5 –∞–∫—Ç–∏–≤–Ω—ã—Ö
- **–ê–Ω–∞–ª–∏–∑—ã:** 200/–º–µ—Å—è—Ü
- **–≠–∫—Å–ø–æ—Ä—Ç—ã:** 50/–º–µ—Å—è—Ü
- **–§—É–Ω–∫—Ü–∏–∏:**
  - ‚úÖ –í—Å—ë –∏–∑ Free
  - ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã

### Professional
- **–¶–µ–Ω–∞:** 5990 ‚ÇΩ/–º–µ—Å –∏–ª–∏ 59900 ‚ÇΩ/–≥–æ–¥ (~16% —Å–∫–∏–¥–∫–∞)
- **–í–∞–∫–∞–Ω—Å–∏–∏:** 20 –∞–∫—Ç–∏–≤–Ω—ã—Ö
- **–ê–Ω–∞–ª–∏–∑—ã:** 1000/–º–µ—Å—è—Ü
- **–≠–∫—Å–ø–æ—Ä—Ç—ã:** 200/–º–µ—Å—è—Ü
- **–§—É–Ω–∫—Ü–∏–∏:**
  - ‚úÖ –í—Å—ë –∏–∑ Starter
  - ‚úÖ API –¥–æ—Å—Ç—É–ø
  - ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
  - ‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ –æ—Ç—á—ë—Ç—ã
  - ‚úÖ Bulk –æ–ø–µ—Ä–∞—Ü–∏–∏
  - ‚úÖ Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### Enterprise
- **–¶–µ–Ω–∞:** –ü–æ –∑–∞–ø—Ä–æ—Å—É
- **–í–∞–∫–∞–Ω—Å–∏–∏:** –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **–ê–Ω–∞–ª–∏–∑—ã:** –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **–≠–∫—Å–ø–æ—Ä—Ç—ã:** –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **–§—É–Ω–∫—Ü–∏–∏:**
  - ‚úÖ –í—Å—ë –∏–∑ Professional
  - ‚úÖ –ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞
  - ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
  - ‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
  - ‚úÖ SLA –≥–∞—Ä–∞–Ω—Ç–∏–∏
  - ‚úÖ –ü–æ–º–æ—â—å —Å –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ–º

---

## üîß API Endpoints

### `GET /api/subscription/plans`
–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤.

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "plans": [
      {
        "id": "...",
        "plan_type": "free",
        "name": "Free",
        "description": "...",
        "pricing": {
          "monthly": 0,
          "yearly": 0,
          "currency": "RUB",
          "yearly_discount": 0
        },
        "limits": {
          "active_vacancies": 1,
          "analyses_per_month": 20,
          "exports_per_month": 5
        },
        "features": {
          "basic_analysis": true,
          "api_access": false,
          ...
        }
      },
      ...
    ]
  }
}
```

### `GET /api/subscription/current`
–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "subscription": {
      "id": "...",
      "user_id": "...",
      "plan": { /* SubscriptionPlan */ },
      "status": "active",
      "is_active": true,
      "period": {
        "started_at": "2025-10-13T10:00:00",
        "expires_at": "2025-11-13T10:00:00",
        "days_remaining": 30
      },
      "usage": {
        "analyses": {
          "used": 5,
          "limit": 20,
          "percentage": 25.0
        },
        "exports": {
          "used": 2,
          "limit": 5,
          "percentage": 40.0
        }
      }
    }
  }
}
```

### `POST /api/subscription/upgrade`
–û–±–Ω–æ–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω.

**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "plan_type": "professional",
  "duration_months": 12
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `plan_type` - –¢–∏–ø –ø–ª–∞–Ω–∞ (free, starter, professional, enterprise)
- `duration_months` - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (1 –∏–ª–∏ 12 –º–µ—Å—è—Ü–µ–≤)

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "subscription": { /* –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ */ },
    "message": "–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ —Ç–∞—Ä–∏—Ñ Professional"
  }
}
```

### `GET /api/subscription/usage?days=30`
–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `days` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (1-365)

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "period_days": 30,
    "subscription": { /* —Ç–µ–∫—É—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ */ },
    "total_usage": {
      "analysis": 45,
      "export": 12,
      "sync": 8
    },
    "daily_usage": {
      "2025-10-01": {
        "analysis": 3,
        "export": 1
      },
      "2025-10-02": {
        "analysis": 5,
        "export": 2
      },
      ...
    }
  }
}
```

### `GET /api/subscription/limits/check`
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π.

**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "can_analyze": true,
    "can_export": false,
    "can_add_vacancy": true,
    "messages": {
      "analyze": null,
      "export": "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —ç–∫—Å–ø–æ—Ä—Ç–æ–≤ (5 –≤ –º–µ—Å—è—Ü)",
      "vacancy": null
    }
  }
}
```

### `POST /api/subscription/cancel`
–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.

**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "subscription": { /* –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ */ },
    "message": "–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –î–æ—Å—Ç—É–ø —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –¥–æ 13.11.2025"
  }
}
```

---

## üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏–µ–π

```python
from app.services.subscription_service import SubscriptionService

# –í –≤–∞—à–µ–º endpoint
@router.post("/analyze")
async def analyze_application(
    application_id: str,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
    service = SubscriptionService(db)
    can_analyze, error_msg = await service.check_can_analyze(current_user.id)

    if not can_analyze:
        return bad_request(
            error="LIMIT_EXCEEDED",
            message=error_msg
        )

    # –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑
    result = await perform_analysis(application_id)

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    await service.increment_analysis_usage(
        user_id=current_user.id,
        application_id=application_id,
        metadata={"score": result.score}
    )

    return success(data=result.to_dict())
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏–∏

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ç–∞—Ä–∏—Ñ–µ
service = SubscriptionService(db)
has_access, error_msg = await service.check_feature_access(
    user_id=current_user.id,
    feature_name="api_access"
)

if not has_access:
    return bad_request(
        error="FEATURE_NOT_AVAILABLE",
        message="API –¥–æ—Å—Ç—É–ø –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –≤–∞—à–µ–º —Ç–∞—Ä–∏—Ñ–µ"
    )
```

---

## üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤

```bash
cd backend
python app/scripts/init_subscription_plans.py
```

–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç 4 —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

### –®–∞–≥ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–∏—Å—Ç–µ–º–µ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑:

```python
subscription = await service.get_or_create_subscription(user_id)
```

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –º–µ—Å—è—á–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–∂–¥—ã–µ 30 –¥–Ω–µ–π:

```python
if subscription.should_reset_monthly_usage():
    subscription.reset_monthly_usage()
    db.commit()
```

### –ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏

–ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:
1. –ü–æ–¥–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å `expired`
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º Free –ø–ª–∞–Ω–∞

### –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

–ü—Ä–∏ –æ—Ç–º–µ–Ω–µ:
1. –ü–æ–¥–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å `cancelled`
2. –î–æ—Å—Ç—É–ø —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–æ –∫–æ–Ω—Ü–∞ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
3. –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –¢–∞–±–ª–∏—Ü–∞ `usage_logs`

–°–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö:
- –ö—Ç–æ –∏ –∫–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–∏–ª –æ–ø–µ—Ä–∞—Ü–∏—é
- –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (analysis, export, sync)
- –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (vacancy_id, application_id)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

```sql
-- –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞–Ω–∞–ª–∏–∑–æ–≤
SELECT user_id, COUNT(*) as analyses_count
FROM usage_logs
WHERE action_type = 'analysis'
  AND created_at >= DATE('now', '-30 days')
GROUP BY user_id
ORDER BY analyses_count DESC
LIMIT 10;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
SELECT sp.name, COUNT(DISTINCT u.id) as users_count,
       AVG(s.analyses_used_this_month) as avg_analyses
FROM subscriptions s
JOIN subscription_plans sp ON s.plan_id = sp.id
JOIN users u ON s.user_id = u.id
WHERE s.status = 'active'
GROUP BY sp.name;
```

---

## üîê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç—ë–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

Endpoint `/api/subscription/upgrade` –≥–æ—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å:
- YooKassa (–Ø–Ω–¥–µ–∫—Å.–ö–∞—Å—Å–∞)
- CloudPayments
- Robokassa
- Stripe (–¥–ª—è –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)

### –ê–ª–≥–æ—Ä–∏—Ç–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
2. –°–æ–∑–¥–∞—ë—Ç—Å—è –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—ë–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É
3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è webhook
4. Webhook –≤—ã–∑—ã–≤–∞–µ—Ç `/api/subscription/upgrade`
5. –ü–æ–¥–ø–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [x] –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (SubscriptionPlan, Subscription, UsageLog)
- [x] –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ (SubscriptionService)
- [x] API endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- [x] –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞—Ä–∏—Ñ–æ–≤
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [x] –ê–≤—Ç–æ—Å–±—Ä–æ—Å –º–µ—Å—è—á–Ω—ã—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
- [ ] Frontend –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤
- [ ] Frontend –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π
- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞

```python
# –í analysis.py
@router.post("/analyze/{application_id}")
async def analyze_application(
    application_id: str,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    service = SubscriptionService(db)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
    can_analyze, msg = await service.check_can_analyze(current_user.id)
    if not can_analyze:
        raise HTTPException(status_code=429, detail=msg)

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
    result = analyze(application_id)

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
    await service.increment_analysis_usage(
        user_id=current_user.id,
        application_id=application_id
    )

    return result
```

### –ü—Ä–∏–º–µ—Ä 2: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞

```python
# –í analysis.py
@router.get("/export/excel")
async def export_to_excel(
    vacancy_id: str,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    service = SubscriptionService(db)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞
    can_export, msg = await service.check_can_export(current_user.id)
    if not can_export:
        raise HTTPException(status_code=429, detail=msg)

    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
    file = create_excel_report(vacancy_id)

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
    await service.increment_export_usage(
        user_id=current_user.id,
        vacancy_id=vacancy_id
    )

    return FileResponse(file)
```

### –ü—Ä–∏–º–µ—Ä 3: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–π

```python
# –í vacancies.py
@router.post("/")
async def create_vacancy(
    vacancy_data: VacancyCreate,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    service = SubscriptionService(db)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –≤–∞–∫–∞–Ω—Å–∏–π
    can_create, msg = await service.check_vacancy_limit(current_user.id)
    if not can_create:
        raise HTTPException(status_code=429, detail=msg)

    # –°–æ–∑–¥–∞—ë–º –≤–∞–∫–∞–Ω—Å–∏—é
    vacancy = Vacancy(**vacancy_data.dict(), user_id=current_user.id)
    db.add(vacancy)
    db.commit()

    return vacancy
```

---

## üéØ –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

### –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:

1. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
   - –ó–∞ 7 –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
   - –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 80% –ª–∏–º–∏—Ç–∞
   - –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ —Ñ—É–Ω–∫—Ü–∏–π

2. **–ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–∫–∏–¥–∫–∏**
   - –¢–∞–±–ª–∏—Ü–∞ promo_codes
   - –°–∫–∏–¥–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

3. **–ö–æ–º–∞–Ω–¥–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏**
   - –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –æ–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
   - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

4. **–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**
   - Dashboard –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
   - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ –ª–∏–º–∏—Ç–æ–≤
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

5. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤**
   - –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã
   - –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞:** 13 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 1.0
