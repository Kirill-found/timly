# Проблемы и их решение

## Проблема 1: Анализ прерывается при переключении страниц

**Причина**: При размонтировании компонента Analysis.tsx срабатывает cleanup в useEffect, который очищает все интервалы.

**Решение**:
1. Убрать cleanup в useEffect для polling интервала
2. Переместить логику polling на уровень глобального провайдера (AppProvider)
3. Использовать глобальное состояние для хранения прогресса анализа

**Код для исправления в Analysis.tsx** (строка ~218-235):

```typescript
// УДАЛИТЬ cleanup return в useEffect:
// return () => {
//   if (pollIntervalRef.current) {
//     clearInterval(pollIntervalRef.current);
//   }
// };

// ОСТАВИТЬ ТОЛЬКО для visibilitychange
return () => {
  document.removeEventListener('visibilitychange', handleVisibilityChange);
};
```

## Проблема 2: NaN% в отображении лимитов

**Причина**: Backend endpoint `/api/subscription/limits/check` не возвращает поля:
- `analyses_remaining`
- `analyses_used`
- `analyses_limit`
- `is_unlimited`
- `reset_date`

**Временное решение**: Использовать endpoint `/api/subscription/usage` который уже существует и возвращает `analyses_count`.

**Постоянное решение**: Нужно исправить код в `backend/app/api/subscription.py` (строки 210-269), но есть проблема с перезапуском backend контейнера из-за Docker ошибки 'ContainerConfig'.

## Временный работающий компонент AnalysisLimitsDisplay

Компонент который работает с текущим API без изменений backend:

```typescript
import React, { useEffect, useState } from 'react';
import { apiClient } from '@/services/api';
import { Card, CardContent } from '@/components/ui/card';
import { Brain, AlertTriangle } from 'lucide-react';
import { Progress } from '@/components/ui/progress';

export const AnalysisLimitsDisplay: React.FC = () => {
  const [stats, setStats] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadStats();
    const interval = setInterval(loadStats, 30000);
    return () => clearInterval(interval);
  }, []);

  const loadStats = async () => {
    try {
      const data = await apiClient.getUsageStatistics(30);
      setStats(data);
    } catch (err) {
      console.error('Error loading stats:', err);
    } finally {
      setLoading(false);
    }
  };

  if (loading || !stats) return null;

  const analysesUsed = stats.analyses_count || 0;
  // Захардкодим лимит пока backend не исправлен
  const analysesLimit = 500; // Professional план
  const analysesRemaining = Math.max(0, analysesLimit - analysesUsed);
  const usagePercent = (analysesUsed / analysesLimit) * 100;
  const isLowRemaining = analysesRemaining < analysesLimit * 0.2;
  const isAlmostOut = analysesRemaining < 50;

  return (
    <Card className={`${
      isAlmostOut
        ? 'border-red-200 bg-gradient-to-r from-red-50 to-orange-50'
        : isLowRemaining
        ? 'border-yellow-200 bg-gradient-to-r from-yellow-50 to-orange-50'
        : 'border-blue-200 bg-gradient-to-r from-blue-50 to-cyan-50'
    }`}>
      <CardContent className="p-4">
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className={`p-2 rounded-lg ${
                isAlmostOut ? 'bg-red-100' : isLowRemaining ? 'bg-yellow-100' : 'bg-blue-100'
              }`}>
                {isAlmostOut || isLowRemaining ? (
                  <AlertTriangle className={`h-5 w-5 ${
                    isAlmostOut ? 'text-red-600' : 'text-yellow-600'
                  }`} />
                ) : (
                  <Brain className="h-5 w-5 text-blue-600" />
                )}
              </div>
              <div>
                <div className={`font-semibold ${
                  isAlmostOut ? 'text-red-900' : isLowRemaining ? 'text-yellow-900' : 'text-blue-900'
                }`}>
                  Анализов осталось: {analysesRemaining}
                </div>
                <div className={`text-sm ${
                  isAlmostOut ? 'text-red-700' : isLowRemaining ? 'text-yellow-700' : 'text-blue-700'
                }`}>
                  Использовано: {analysesUsed} из {analysesLimit}
                </div>
              </div>
            </div>
            <div className={`text-2xl font-bold ${
              isAlmostOut ? 'text-red-600' : isLowRemaining ? 'text-yellow-600' : 'text-blue-600'
            }`}>
              {Math.round(usagePercent)}%
            </div>
          </div>

          <Progress
            value={usagePercent}
            className={`h-2 ${
              isAlmostOut ? '[&>div]:bg-red-500' : isLowRemaining ? '[&>div]:bg-yellow-500' : '[&>div]:bg-blue-500'
            }`}
          />

          {isAlmostOut && (
            <div className="text-xs text-red-600 font-medium text-center">
              ⚠️ Анализы заканчиваются! Рассмотрите обновление тарифного плана
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
};
```

## Что нужно сделать для полного исправления

1. **Исправить Docker проблему на сервере**:
   ```bash
   ssh root@188.225.24.157
   docker system prune -a -f
   systemctl restart docker
   ```

2. **Применить изменения в backend/app/api/subscription.py** (уже сделано локально, нужно только задеплоить после исправления Docker)

3. **Убрать cleanup в Analysis.tsx** для сохранения polling при переключении страниц

4. **Обновить AnalysisLimitsDisplay.tsx** чтобы использовать правильные поля после исправления backend
